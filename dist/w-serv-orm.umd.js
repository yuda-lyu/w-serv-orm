/*!
 * w-serv-orm v1.0.8
 * (c) 2018-2021 yuda-lyu(semisphere)
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("fs")):"function"==typeof define&&define.amd?define(["fs"],e):(t="undefined"!=typeof globalThis?globalThis:t||self)["w-serv-orm"]=e(t.fs)}(this,(function(t){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function r(t){var r=function(t,r){if("object"!==e(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,r||"default");if("object"!==e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"===e(r)?r:String(r)}function n(t,e,n){return(e=r(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var o="object"==typeof global&&global&&global.Object===Object&&global,i="object"==typeof self&&self&&self.Object===Object&&self,u=o||i||Function("return this")(),a=u.Symbol;function c(t,e){for(var r=-1,n=null==t?0:t.length,o=Array(n);++r<n;)o[r]=e(t[r],r,t);return o}var s=Array.isArray,f=Object.prototype,l=f.hasOwnProperty,d=f.toString,h=a?a.toStringTag:void 0;var v=Object.prototype.toString;var p="[object Null]",y="[object Undefined]",b=a?a.toStringTag:void 0;function g(t){return null==t?void 0===t?y:p:b&&b in Object(t)?function(t){var e=l.call(t,h),r=t[h];try{t[h]=void 0;var n=!0}catch(t){}var o=d.call(t);return n&&(e?t[h]=r:delete t[h]),o}(t):function(t){return v.call(t)}(t)}function m(t){return null!=t&&"object"==typeof t}var j="[object Symbol]";function _(t){return"symbol"==typeof t||m(t)&&g(t)==j}var w=1/0,O=a?a.prototype:void 0,$=O?O.toString:void 0;function S(t){if("string"==typeof t)return t;if(s(t))return c(t,S)+"";if(_(t))return $?$.call(t):"";var e=t+"";return"0"==e&&1/t==-w?"-0":e}var D=/\s/;var M=/^\s+/;function P(t){return t?t.slice(0,function(t){for(var e=t.length;e--&&D.test(t.charAt(e)););return e}(t)+1).replace(M,""):t}function A(t,e,r){var n=-1,o=t.length;e<0&&(e=-e>o?0:o+e),(r=r>o?o:r)<0&&(r+=o),o=e>r?0:r-e>>>0,e>>>=0;for(var i=Array(o);++n<o;)i[n]=t[n+e];return i}function x(t){return t!=t}function k(t,e,r){return e==e?function(t,e,r){for(var n=r-1,o=t.length;++n<o;)if(t[n]===e)return n;return-1}(t,e,r):function(t,e,r,n){for(var o=t.length,i=r+(n?1:-1);n?i--:++i<o;)if(e(t[i],i,t))return i;return-1}(t,x,r)}var I=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");function T(t){return I.test(t)}var z="\\ud800-\\udfff",E="["+z+"]",N="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",F="\\ud83c[\\udffb-\\udfff]",C="[^"+z+"]",U="(?:\\ud83c[\\udde6-\\uddff]){2}",Y="[\\ud800-\\udbff][\\udc00-\\udfff]",L="(?:"+N+"|"+F+")"+"?",W="[\\ufe0e\\ufe0f]?",H=W+L+("(?:\\u200d(?:"+[C,U,Y].join("|")+")"+W+L+")*"),B="(?:"+[C+N+"?",N,U,Y,E].join("|")+")",R=RegExp(F+"(?="+F+")|"+B+H,"g");function V(t){return T(t)?function(t){return t.match(R)||[]}(t):function(t){return t.split("")}(t)}function J(t){return null==t?"":S(t)}function Z(t,e,r){if((t=J(t))&&(r||void 0===e))return P(t);if(!t||!(e=S(e)))return t;var n=V(t),o=V(e),i=function(t,e){for(var r=-1,n=t.length;++r<n&&k(e,t[r],0)>-1;);return r}(n,o),u=function(t,e){for(var r=t.length;r--&&k(e,t[r],0)>-1;);return r}(n,o)+1;return function(t,e,r){var n=t.length;return r=void 0===r?n:r,!e&&r>=n?t:A(t,e,r)}(n,i,u).join("")}var q=Object.prototype;var G,K,Q=(G=Object.keys,K=Object,function(t){return G(K(t))}),X=Object.prototype.hasOwnProperty;function tt(t){if(r=(e=t)&&e.constructor,e!==("function"==typeof r&&r.prototype||q))return Q(t);var e,r,n=[];for(var o in Object(t))X.call(t,o)&&"constructor"!=o&&n.push(o);return n}function et(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var rt="[object AsyncFunction]",nt="[object Function]",ot="[object GeneratorFunction]",it="[object Proxy]";function ut(t){if(!et(t))return!1;var e=g(t);return e==nt||e==ot||e==rt||e==it}var at,ct=u["__core-js_shared__"],st=(at=/[^.]+$/.exec(ct&&ct.keys&&ct.keys.IE_PROTO||""))?"Symbol(src)_1."+at:"";var ft=Function.prototype.toString;function lt(t){if(null!=t){try{return ft.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var dt=/^\[object .+?Constructor\]$/,ht=Function.prototype,vt=Object.prototype,pt=ht.toString,yt=vt.hasOwnProperty,bt=RegExp("^"+pt.call(yt).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function gt(t){return!(!et(t)||function(t){return!!st&&st in t}(t))&&(ut(t)?bt:dt).test(lt(t))}function mt(t,e){var r=function(t,e){return null==t?void 0:t[e]}(t,e);return gt(r)?r:void 0}var jt=mt(u,"DataView"),_t=mt(u,"Map"),wt=mt(u,"Promise"),Ot=mt(u,"Set"),$t=mt(u,"WeakMap"),St="[object Map]",Dt="[object Promise]",Mt="[object Set]",Pt="[object WeakMap]",At="[object DataView]",xt=lt(jt),kt=lt(_t),It=lt(wt),Tt=lt(Ot),zt=lt($t),Et=g;(jt&&Et(new jt(new ArrayBuffer(1)))!=At||_t&&Et(new _t)!=St||wt&&Et(wt.resolve())!=Dt||Ot&&Et(new Ot)!=Mt||$t&&Et(new $t)!=Pt)&&(Et=function(t){var e=g(t),r="[object Object]"==e?t.constructor:void 0,n=r?lt(r):"";if(n)switch(n){case xt:return At;case kt:return St;case It:return Dt;case Tt:return Mt;case zt:return Pt}return e});var Nt=Et,Ft=9007199254740991;function Ct(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=Ft}function Ut(t){return null!=t&&Ct(t.length)&&!ut(t)}var Yt="[object String]";function Lt(t){return function(e){return null==e?void 0:e[t]}}var Wt=Lt("length"),Ht="\\ud800-\\udfff",Bt="["+Ht+"]",Rt="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",Vt="\\ud83c[\\udffb-\\udfff]",Jt="[^"+Ht+"]",Zt="(?:\\ud83c[\\udde6-\\uddff]){2}",qt="[\\ud800-\\udbff][\\udc00-\\udfff]",Gt="(?:"+Rt+"|"+Vt+")"+"?",Kt="[\\ufe0e\\ufe0f]?",Qt=Kt+Gt+("(?:\\u200d(?:"+[Jt,Zt,qt].join("|")+")"+Kt+Gt+")*"),Xt="(?:"+[Jt+Rt+"?",Rt,Zt,qt,Bt].join("|")+")",te=RegExp(Vt+"(?="+Vt+")|"+Xt+Qt,"g");function ee(t){return T(t)?function(t){for(var e=te.lastIndex=0;te.test(t);)++e;return e}(t):Wt(t)}var re="[object Map]",ne="[object Set]";function oe(t){if(null==t)return 0;if(Ut(t))return"string"==typeof(e=t)||!s(e)&&m(e)&&g(e)==Yt?ee(t):t.length;var e,r=Nt(t);return r==re||r==ne?t.size:tt(t).length}var ie=NaN,ue=/^[-+]0x[0-9a-f]+$/i,ae=/^0b[01]+$/i,ce=/^0o[0-7]+$/i,se=parseInt;var fe=1/0,le=17976931348623157e292;function de(t){return t?(t=function(t){if("number"==typeof t)return t;if(_(t))return ie;if(et(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=et(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=P(t);var r=ae.test(t);return r||ce.test(t)?se(t.slice(2),r?2:8):ue.test(t)?ie:+t}(t))===fe||t===-fe?(t<0?-1:1)*le:t==t?t:0:0===t?t:0}function he(t,e,r){var n,o,i=null==t?0:t.length;return i?A(t,(e=r||void 0===e?1:(n=de(e),o=n%1,n==n?o?n-o:n:0))<0?0:e,i):[]}function ve(t,e){for(var r=-1,n=null==t?0:t.length;++r<n&&!1!==e(t[r],r,t););return t}var pe,ye=function(t,e,r){for(var n=-1,o=Object(t),i=r(t),u=i.length;u--;){var a=i[pe?u:++n];if(!1===e(o[a],a,o))break}return t};function be(t){return m(t)&&"[object Arguments]"==g(t)}var ge=Object.prototype,me=ge.hasOwnProperty,je=ge.propertyIsEnumerable,_e=be(function(){return arguments}())?be:function(t){return m(t)&&me.call(t,"callee")&&!je.call(t,"callee")},we=_e;var Oe="object"==typeof exports&&exports&&!exports.nodeType&&exports,$e=Oe&&"object"==typeof module&&module&&!module.nodeType&&module,Se=$e&&$e.exports===Oe?u.Buffer:void 0,De=(Se?Se.isBuffer:void 0)||function(){return!1},Me=9007199254740991,Pe=/^(?:0|[1-9]\d*)$/;function Ae(t,e){var r=typeof t;return!!(e=null==e?Me:e)&&("number"==r||"symbol"!=r&&Pe.test(t))&&t>-1&&t%1==0&&t<e}var xe={};xe["[object Float32Array]"]=xe["[object Float64Array]"]=xe["[object Int8Array]"]=xe["[object Int16Array]"]=xe["[object Int32Array]"]=xe["[object Uint8Array]"]=xe["[object Uint8ClampedArray]"]=xe["[object Uint16Array]"]=xe["[object Uint32Array]"]=!0,xe["[object Arguments]"]=xe["[object Array]"]=xe["[object ArrayBuffer]"]=xe["[object Boolean]"]=xe["[object DataView]"]=xe["[object Date]"]=xe["[object Error]"]=xe["[object Function]"]=xe["[object Map]"]=xe["[object Number]"]=xe["[object Object]"]=xe["[object RegExp]"]=xe["[object Set]"]=xe["[object String]"]=xe["[object WeakMap]"]=!1;var ke="object"==typeof exports&&exports&&!exports.nodeType&&exports,Ie=ke&&"object"==typeof module&&module&&!module.nodeType&&module,Te=Ie&&Ie.exports===ke&&o.process,ze=function(){try{var t=Ie&&Ie.require&&Ie.require("util").types;return t||Te&&Te.binding&&Te.binding("util")}catch(t){}}(),Ee=ze&&ze.isTypedArray,Ne=Ee?function(t){return function(e){return t(e)}}(Ee):function(t){return m(t)&&Ct(t.length)&&!!xe[g(t)]},Fe=Ne,Ce=Object.prototype.hasOwnProperty;function Ue(t,e){var r=s(t),n=!r&&we(t),o=!r&&!n&&De(t),i=!r&&!n&&!o&&Fe(t),u=r||n||o||i,a=u?function(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n}(t.length,String):[],c=a.length;for(var f in t)!e&&!Ce.call(t,f)||u&&("length"==f||o&&("offset"==f||"parent"==f)||i&&("buffer"==f||"byteLength"==f||"byteOffset"==f)||Ae(f,c))||a.push(f);return a}function Ye(t){return Ut(t)?Ue(t):tt(t)}var Le=function(t,e){return function(r,n){if(null==r)return r;if(!Ut(r))return t(r,n);for(var o=r.length,i=e?o:-1,u=Object(r);(e?i--:++i<o)&&!1!==n(u[i],i,u););return r}}((function(t,e){return t&&ye(t,e,Ye)})),We=Le;function He(t){return t}function Be(t,e){var r;return(s(t)?ve:We)(t,"function"==typeof(r=e)?r:He)}function Re(){let t,e,r=new Promise((function(){t=arguments[0],e=arguments[1]}));return r.resolve=t,r.reject=e,r}function Ve(t){return"[object Array]"===Object.prototype.toString.call(t)}function Je(t){return"[object Object]"===Object.prototype.toString.call(t)}function Ze(t){let e=Object.prototype.toString.call(t);return"[object Function]"===e||"[object AsyncFunction]"===e}function qe(t,e){let r=Re();if(!Ve(t)&&!Je(t))return r.reject("rs is not an array or object"),r;let n=!1;if(Je(t)){n=!0;let e=[];Be(t,((t,r)=>{e.push({k:r,v:t})})),t=e}Ze(e)||(e=function(t){return t});let o=-1,i=[];return t.reduce((function(t,r){return t.then((function(t){i.push(t),o+=1;let u=o,a=r;return n&&(u=r.k,a=r.v),Ze(e)?e(a,u):a}))}),Promise.resolve()).then((function(t){i.push(t),i=he(i),r.resolve(i)})).catch((function(t){r.reject(t)})),r}function Ge(t){if(Je(t)){for(let e in t)return!0;return!1}return!1}var Ke="[object Boolean]";function Qe(t){return!0===(e=t)||!1===e||m(e)&&g(e)==Ke;var e}function Xe(t){return!(!function(t){return"[object String]"===Object.prototype.toString.call(t)}(t)||""===t)}let tr={backup:async function(t){return await qe(t,(async(t,e)=>(console.log("backup...",e),{name:e,data:await t.select()})))},recover:async function(e,r,n){let o=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(i=e,!t.existsSync(i)||t.lstatSync(i).isDirectory()||t.lstatSync(i).isSymbolicLink())throw console.log("fp",e),new Error("fp is not exist");var i;if(!Ge(r))throw console.log("woItems",r),new Error("invalid woItems");Ze(n)||(n=null),Qe(o)||(o=!1);let u=t.readFileSync(e,"utf8");u=Z(u);let a=function(t){if(!Xe(t))return{};let e={};try{e=JSON.parse(t)}catch(t){e={}}return e}(u);Ze(n)&&n(),await qe(a,(async t=>{console.log("recover...",t.name),o&&(console.log("needCreateStorage"),await r[t.name].createStorage());let e=null;return oe(t.data)>0&&(e=await r[t.name].insert(t.data)),e}))}};var er=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,rr=/^\w*$/;function nr(t,e){if(s(t))return!1;var r=typeof t;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=t&&!_(t))||(rr.test(t)||!er.test(t)||null!=e&&t in Object(e))}var or=mt(Object,"create");var ir=Object.prototype.hasOwnProperty;var ur=Object.prototype.hasOwnProperty;function ar(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}function cr(t,e){return t===e||t!=t&&e!=e}function sr(t,e){for(var r=t.length;r--;)if(cr(t[r][0],e))return r;return-1}ar.prototype.clear=function(){this.__data__=or?or(null):{},this.size=0},ar.prototype.delete=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},ar.prototype.get=function(t){var e=this.__data__;if(or){var r=e[t];return"__lodash_hash_undefined__"===r?void 0:r}return ir.call(e,t)?e[t]:void 0},ar.prototype.has=function(t){var e=this.__data__;return or?void 0!==e[t]:ur.call(e,t)},ar.prototype.set=function(t,e){var r=this.__data__;return this.size+=this.has(t)?0:1,r[t]=or&&void 0===e?"__lodash_hash_undefined__":e,this};var fr=Array.prototype.splice;function lr(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}function dr(t,e){var r,n,o=t.__data__;return("string"==(n=typeof(r=e))||"number"==n||"symbol"==n||"boolean"==n?"__proto__"!==r:null===r)?o["string"==typeof e?"string":"hash"]:o.map}function hr(t){var e=-1,r=null==t?0:t.length;for(this.clear();++e<r;){var n=t[e];this.set(n[0],n[1])}}lr.prototype.clear=function(){this.__data__=[],this.size=0},lr.prototype.delete=function(t){var e=this.__data__,r=sr(e,t);return!(r<0)&&(r==e.length-1?e.pop():fr.call(e,r,1),--this.size,!0)},lr.prototype.get=function(t){var e=this.__data__,r=sr(e,t);return r<0?void 0:e[r][1]},lr.prototype.has=function(t){return sr(this.__data__,t)>-1},lr.prototype.set=function(t,e){var r=this.__data__,n=sr(r,t);return n<0?(++this.size,r.push([t,e])):r[n][1]=e,this},hr.prototype.clear=function(){this.size=0,this.__data__={hash:new ar,map:new(_t||lr),string:new ar}},hr.prototype.delete=function(t){var e=dr(this,t).delete(t);return this.size-=e?1:0,e},hr.prototype.get=function(t){return dr(this,t).get(t)},hr.prototype.has=function(t){return dr(this,t).has(t)},hr.prototype.set=function(t,e){var r=dr(this,t),n=r.size;return r.set(t,e),this.size+=r.size==n?0:1,this};var vr="Expected a function";function pr(t,e){if("function"!=typeof t||null!=e&&"function"!=typeof e)throw new TypeError(vr);var r=function(){var n=arguments,o=e?e.apply(this,n):n[0],i=r.cache;if(i.has(o))return i.get(o);var u=t.apply(this,n);return r.cache=i.set(o,u)||i,u};return r.cache=new(pr.Cache||hr),r}pr.Cache=hr;var yr=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,br=/\\(\\)?/g,gr=function(t){var e=pr(t,(function(t){return 500===r.size&&r.clear(),t})),r=e.cache;return e}((function(t){var e=[];return 46===t.charCodeAt(0)&&e.push(""),t.replace(yr,(function(t,r,n,o){e.push(n?o.replace(br,"$1"):r||t)})),e})),mr=gr;function jr(t,e){return s(t)?t:nr(t,e)?[t]:mr(J(t))}var _r=1/0;function wr(t){if("string"==typeof t||_(t))return t;var e=t+"";return"0"==e&&1/t==-_r?"-0":e}function Or(t,e){for(var r=0,n=(e=jr(e,t)).length;null!=t&&r<n;)t=t[wr(e[r++])];return r&&r==n?t:void 0}function $r(t,e,r){var n=null==t?void 0:Or(t,e);return void 0===n?r:n}function Sr(t){var e=this.__data__=new lr(t);this.size=e.size}Sr.prototype.clear=function(){this.__data__=new lr,this.size=0},Sr.prototype.delete=function(t){var e=this.__data__,r=e.delete(t);return this.size=e.size,r},Sr.prototype.get=function(t){return this.__data__.get(t)},Sr.prototype.has=function(t){return this.__data__.has(t)},Sr.prototype.set=function(t,e){var r=this.__data__;if(r instanceof lr){var n=r.__data__;if(!_t||n.length<199)return n.push([t,e]),this.size=++r.size,this;r=this.__data__=new hr(n)}return r.set(t,e),this.size=r.size,this};function Dr(t){var e=-1,r=null==t?0:t.length;for(this.__data__=new hr;++e<r;)this.add(t[e])}function Mr(t,e){for(var r=-1,n=null==t?0:t.length;++r<n;)if(e(t[r],r,t))return!0;return!1}Dr.prototype.add=Dr.prototype.push=function(t){return this.__data__.set(t,"__lodash_hash_undefined__"),this},Dr.prototype.has=function(t){return this.__data__.has(t)};var Pr=1,Ar=2;function xr(t,e,r,n,o,i){var u=r&Pr,a=t.length,c=e.length;if(a!=c&&!(u&&c>a))return!1;var s=i.get(t),f=i.get(e);if(s&&f)return s==e&&f==t;var l=-1,d=!0,h=r&Ar?new Dr:void 0;for(i.set(t,e),i.set(e,t);++l<a;){var v=t[l],p=e[l];if(n)var y=u?n(p,v,l,e,t,i):n(v,p,l,t,e,i);if(void 0!==y){if(y)continue;d=!1;break}if(h){if(!Mr(e,(function(t,e){if(u=e,!h.has(u)&&(v===t||o(v,t,r,n,i)))return h.push(e);var u}))){d=!1;break}}else if(v!==p&&!o(v,p,r,n,i)){d=!1;break}}return i.delete(t),i.delete(e),d}var kr=u.Uint8Array;function Ir(t){var e=-1,r=Array(t.size);return t.forEach((function(t,n){r[++e]=[n,t]})),r}function Tr(t){var e=-1,r=Array(t.size);return t.forEach((function(t){r[++e]=t})),r}var zr=1,Er=2,Nr="[object Boolean]",Fr="[object Date]",Cr="[object Error]",Ur="[object Map]",Yr="[object Number]",Lr="[object RegExp]",Wr="[object Set]",Hr="[object String]",Br="[object Symbol]",Rr="[object ArrayBuffer]",Vr="[object DataView]",Jr=a?a.prototype:void 0,Zr=Jr?Jr.valueOf:void 0;function qr(t,e){for(var r=-1,n=null==t?0:t.length,o=0,i=[];++r<n;){var u=t[r];e(u,r,t)&&(i[o++]=u)}return i}var Gr=Object.prototype.propertyIsEnumerable,Kr=Object.getOwnPropertySymbols,Qr=Kr?function(t){return null==t?[]:(t=Object(t),qr(Kr(t),(function(e){return Gr.call(t,e)})))}:function(){return[]};function Xr(t){return function(t,e,r){var n=e(t);return s(t)?n:function(t,e){for(var r=-1,n=e.length,o=t.length;++r<n;)t[o+r]=e[r];return t}(n,r(t))}(t,Ye,Qr)}var tn=1,en=Object.prototype.hasOwnProperty;var rn=1,nn="[object Arguments]",on="[object Array]",un="[object Object]",an=Object.prototype.hasOwnProperty;function cn(t,e,r,n,o,i){var u=s(t),a=s(e),c=u?on:Nt(t),f=a?on:Nt(e),l=(c=c==nn?un:c)==un,d=(f=f==nn?un:f)==un,h=c==f;if(h&&De(t)){if(!De(e))return!1;u=!0,l=!1}if(h&&!l)return i||(i=new Sr),u||Fe(t)?xr(t,e,r,n,o,i):function(t,e,r,n,o,i,u){switch(r){case Vr:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case Rr:return!(t.byteLength!=e.byteLength||!i(new kr(t),new kr(e)));case Nr:case Fr:case Yr:return cr(+t,+e);case Cr:return t.name==e.name&&t.message==e.message;case Lr:case Hr:return t==e+"";case Ur:var a=Ir;case Wr:var c=n&zr;if(a||(a=Tr),t.size!=e.size&&!c)return!1;var s=u.get(t);if(s)return s==e;n|=Er,u.set(t,e);var f=xr(a(t),a(e),n,o,i,u);return u.delete(t),f;case Br:if(Zr)return Zr.call(t)==Zr.call(e)}return!1}(t,e,c,r,n,o,i);if(!(r&rn)){var v=l&&an.call(t,"__wrapped__"),p=d&&an.call(e,"__wrapped__");if(v||p){var y=v?t.value():t,b=p?e.value():e;return i||(i=new Sr),o(y,b,r,n,i)}}return!!h&&(i||(i=new Sr),function(t,e,r,n,o,i){var u=r&tn,a=Xr(t),c=a.length;if(c!=Xr(e).length&&!u)return!1;for(var s=c;s--;){var f=a[s];if(!(u?f in e:en.call(e,f)))return!1}var l=i.get(t),d=i.get(e);if(l&&d)return l==e&&d==t;var h=!0;i.set(t,e),i.set(e,t);for(var v=u;++s<c;){var p=t[f=a[s]],y=e[f];if(n)var b=u?n(y,p,f,e,t,i):n(p,y,f,t,e,i);if(!(void 0===b?p===y||o(p,y,r,n,i):b)){h=!1;break}v||(v="constructor"==f)}if(h&&!v){var g=t.constructor,m=e.constructor;g==m||!("constructor"in t)||!("constructor"in e)||"function"==typeof g&&g instanceof g&&"function"==typeof m&&m instanceof m||(h=!1)}return i.delete(t),i.delete(e),h}(t,e,r,n,o,i))}function sn(t,e,r,n,o){return t===e||(null==t||null==e||!m(t)&&!m(e)?t!=t&&e!=e:cn(t,e,r,n,sn,o))}var fn=1,ln=2;function dn(t){return t==t&&!et(t)}function hn(t,e){return function(r){return null!=r&&(r[t]===e&&(void 0!==e||t in Object(r)))}}function vn(t){var e=function(t){for(var e=Ye(t),r=e.length;r--;){var n=e[r],o=t[n];e[r]=[n,o,dn(o)]}return e}(t);return 1==e.length&&e[0][2]?hn(e[0][0],e[0][1]):function(r){return r===t||function(t,e,r,n){var o=r.length,i=o,u=!n;if(null==t)return!i;for(t=Object(t);o--;){var a=r[o];if(u&&a[2]?a[1]!==t[a[0]]:!(a[0]in t))return!1}for(;++o<i;){var c=(a=r[o])[0],s=t[c],f=a[1];if(u&&a[2]){if(void 0===s&&!(c in t))return!1}else{var l=new Sr;if(n)var d=n(s,f,c,t,e,l);if(!(void 0===d?sn(f,s,fn|ln,n,l):d))return!1}}return!0}(r,t,e)}}function pn(t,e){return null!=t&&e in Object(t)}function yn(t,e){return null!=t&&function(t,e,r){for(var n=-1,o=(e=jr(e,t)).length,i=!1;++n<o;){var u=wr(e[n]);if(!(i=null!=t&&r(t,u)))break;t=t[u]}return i||++n!=o?i:!!(o=null==t?0:t.length)&&Ct(o)&&Ae(u,o)&&(s(t)||we(t))}(t,e,pn)}var bn=1,gn=2;function mn(t){return nr(t)?Lt(wr(t)):function(t){return function(e){return Or(e,t)}}(t)}function jn(t){return"function"==typeof t?t:null==t?He:"object"==typeof t?s(t)?(e=t[0],r=t[1],nr(e)&&dn(r)?hn(wr(e),r):function(t){var n=$r(t,e);return void 0===n&&n===r?yn(t,e):sn(r,n,bn|gn)}):vn(t):mn(t);var e,r}function _n(t,e){var r=-1,n=Ut(t)?Array(t.length):[];return We(t,(function(t,o,i){n[++r]=e(t,o,i)})),n}function wn(t,e){return(s(t)?c:_n)(t,jn(e))}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var On={};!function(t,e){t.exports=function(){var t=1e3,e=6e4,r=36e5,n="millisecond",o="second",i="minute",u="hour",a="day",c="week",s="month",f="quarter",l="year",d="date",h="Invalid Date",v=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,p=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,y={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(t){var e=["th","st","nd","rd"],r=t%100;return"["+t+(e[(r-20)%10]||e[r]||e[0])+"]"}},b=function(t,e,r){var n=String(t);return!n||n.length>=e?t:""+Array(e+1-n.length).join(r)+t},g={s:b,z:function(t){var e=-t.utcOffset(),r=Math.abs(e),n=Math.floor(r/60),o=r%60;return(e<=0?"+":"-")+b(n,2,"0")+":"+b(o,2,"0")},m:function t(e,r){if(e.date()<r.date())return-t(r,e);var n=12*(r.year()-e.year())+(r.month()-e.month()),o=e.clone().add(n,s),i=r-o<0,u=e.clone().add(n+(i?-1:1),s);return+(-(n+(r-o)/(i?o-u:u-o))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(t){return{M:s,y:l,w:c,d:a,D:d,h:u,m:i,s:o,ms:n,Q:f}[t]||String(t||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},m="en",j={};j[m]=y;var _="$isDayjsObject",w=function(t){return t instanceof D||!(!t||!t[_])},O=function t(e,r,n){var o;if(!e)return m;if("string"==typeof e){var i=e.toLowerCase();j[i]&&(o=i),r&&(j[i]=r,o=i);var u=e.split("-");if(!o&&u.length>1)return t(u[0])}else{var a=e.name;j[a]=e,o=a}return!n&&o&&(m=o),o||!n&&m},$=function(t,e){if(w(t))return t.clone();var r="object"==typeof e?e:{};return r.date=t,r.args=arguments,new D(r)},S=g;S.l=O,S.i=w,S.w=function(t,e){return $(t,{locale:e.$L,utc:e.$u,x:e.$x,$offset:e.$offset})};var D=function(){function y(t){this.$L=O(t.locale,null,!0),this.parse(t),this.$x=this.$x||t.x||{},this[_]=!0}var b=y.prototype;return b.parse=function(t){this.$d=function(t){var e=t.date,r=t.utc;if(null===e)return new Date(NaN);if(S.u(e))return new Date;if(e instanceof Date)return new Date(e);if("string"==typeof e&&!/Z$/i.test(e)){var n=e.match(v);if(n){var o=n[2]-1||0,i=(n[7]||"0").substring(0,3);return r?new Date(Date.UTC(n[1],o,n[3]||1,n[4]||0,n[5]||0,n[6]||0,i)):new Date(n[1],o,n[3]||1,n[4]||0,n[5]||0,n[6]||0,i)}}return new Date(e)}(t),this.init()},b.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},b.$utils=function(){return S},b.isValid=function(){return!(this.$d.toString()===h)},b.isSame=function(t,e){var r=$(t);return this.startOf(e)<=r&&r<=this.endOf(e)},b.isAfter=function(t,e){return $(t)<this.startOf(e)},b.isBefore=function(t,e){return this.endOf(e)<$(t)},b.$g=function(t,e,r){return S.u(t)?this[e]:this.set(r,t)},b.unix=function(){return Math.floor(this.valueOf()/1e3)},b.valueOf=function(){return this.$d.getTime()},b.startOf=function(t,e){var r=this,n=!!S.u(e)||e,f=S.p(t),h=function(t,e){var o=S.w(r.$u?Date.UTC(r.$y,e,t):new Date(r.$y,e,t),r);return n?o:o.endOf(a)},v=function(t,e){return S.w(r.toDate()[t].apply(r.toDate("s"),(n?[0,0,0,0]:[23,59,59,999]).slice(e)),r)},p=this.$W,y=this.$M,b=this.$D,g="set"+(this.$u?"UTC":"");switch(f){case l:return n?h(1,0):h(31,11);case s:return n?h(1,y):h(0,y+1);case c:var m=this.$locale().weekStart||0,j=(p<m?p+7:p)-m;return h(n?b-j:b+(6-j),y);case a:case d:return v(g+"Hours",0);case u:return v(g+"Minutes",1);case i:return v(g+"Seconds",2);case o:return v(g+"Milliseconds",3);default:return this.clone()}},b.endOf=function(t){return this.startOf(t,!1)},b.$set=function(t,e){var r,c=S.p(t),f="set"+(this.$u?"UTC":""),h=(r={},r[a]=f+"Date",r[d]=f+"Date",r[s]=f+"Month",r[l]=f+"FullYear",r[u]=f+"Hours",r[i]=f+"Minutes",r[o]=f+"Seconds",r[n]=f+"Milliseconds",r)[c],v=c===a?this.$D+(e-this.$W):e;if(c===s||c===l){var p=this.clone().set(d,1);p.$d[h](v),p.init(),this.$d=p.set(d,Math.min(this.$D,p.daysInMonth())).$d}else h&&this.$d[h](v);return this.init(),this},b.set=function(t,e){return this.clone().$set(t,e)},b.get=function(t){return this[S.p(t)]()},b.add=function(n,f){var d,h=this;n=Number(n);var v=S.p(f),p=function(t){var e=$(h);return S.w(e.date(e.date()+Math.round(t*n)),h)};if(v===s)return this.set(s,this.$M+n);if(v===l)return this.set(l,this.$y+n);if(v===a)return p(1);if(v===c)return p(7);var y=(d={},d[i]=e,d[u]=r,d[o]=t,d)[v]||1,b=this.$d.getTime()+n*y;return S.w(b,this)},b.subtract=function(t,e){return this.add(-1*t,e)},b.format=function(t){var e=this,r=this.$locale();if(!this.isValid())return r.invalidDate||h;var n=t||"YYYY-MM-DDTHH:mm:ssZ",o=S.z(this),i=this.$H,u=this.$m,a=this.$M,c=r.weekdays,s=r.months,f=r.meridiem,l=function(t,r,o,i){return t&&(t[r]||t(e,n))||o[r].slice(0,i)},d=function(t){return S.s(i%12||12,t,"0")},v=f||function(t,e,r){var n=t<12?"AM":"PM";return r?n.toLowerCase():n};return n.replace(p,(function(t,n){return n||function(t){switch(t){case"YY":return String(e.$y).slice(-2);case"YYYY":return S.s(e.$y,4,"0");case"M":return a+1;case"MM":return S.s(a+1,2,"0");case"MMM":return l(r.monthsShort,a,s,3);case"MMMM":return l(s,a);case"D":return e.$D;case"DD":return S.s(e.$D,2,"0");case"d":return String(e.$W);case"dd":return l(r.weekdaysMin,e.$W,c,2);case"ddd":return l(r.weekdaysShort,e.$W,c,3);case"dddd":return c[e.$W];case"H":return String(i);case"HH":return S.s(i,2,"0");case"h":return d(1);case"hh":return d(2);case"a":return v(i,u,!0);case"A":return v(i,u,!1);case"m":return String(u);case"mm":return S.s(u,2,"0");case"s":return String(e.$s);case"ss":return S.s(e.$s,2,"0");case"SSS":return S.s(e.$ms,3,"0");case"Z":return o}return null}(t)||o.replace(":","")}))},b.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},b.diff=function(n,d,h){var v,p=this,y=S.p(d),b=$(n),g=(b.utcOffset()-this.utcOffset())*e,m=this-b,j=function(){return S.m(p,b)};switch(y){case l:v=j()/12;break;case s:v=j();break;case f:v=j()/3;break;case c:v=(m-g)/6048e5;break;case a:v=(m-g)/864e5;break;case u:v=m/r;break;case i:v=m/e;break;case o:v=m/t;break;default:v=m}return h?v:S.a(v)},b.daysInMonth=function(){return this.endOf(s).$D},b.$locale=function(){return j[this.$L]},b.locale=function(t,e){if(!t)return this.$L;var r=this.clone(),n=O(t,e,!0);return n&&(r.$L=n),r},b.clone=function(){return S.w(this.$d,this)},b.toDate=function(){return new Date(this.valueOf())},b.toJSON=function(){return this.isValid()?this.toISOString():null},b.toISOString=function(){return this.$d.toISOString()},b.toString=function(){return this.$d.toUTCString()},y}(),M=D.prototype;return $.prototype=M,[["$ms",n],["$s",o],["$m",i],["$H",u],["$W",a],["$M",s],["$y",l],["$D",d]].forEach((function(t){M[t[1]]=function(e){return this.$g(e,t[0],t[1])}})),$.extend=function(t,e){return t.$i||(t(e,D,$),t.$i=!0),$},$.locale=O,$.isDayjs=w,$.unix=function(t){return $(1e3*t)},$.en=j[m],$.Ls=j,$.p={},$}()}({get exports(){return On},set exports(t){On=t}});var $n=On;let Sn=null,Dn=null;function Mn(t,e,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"save";if(!Ge(Sn))throw console.log("ds",Sn),new Error("invalid ds");let o=Sn[t].keys,i=!1;Ve(r)||(i=!0,r=[r]);let u=function(){if(!Ze($n))throw new Error("invalid dayjs");return $n().format("YYYY-MM-DDTHH:mm:ss.SSSZ")}();return n.indexOf("insert")>=0&&(o.indexOf("userId")>=0&&Be(r,((t,n)=>{r[n].userId=e})),o.indexOf("timeCreate")>=0&&Be(r,((t,e)=>{r[e].timeCreate=u}))),(n.indexOf("insert")>=0||n.indexOf("save")>=0)&&(o.indexOf("userIdUpdate")>=0&&Be(r,((t,n)=>{r[n].userIdUpdate=e})),o.indexOf("timeUpdate")>=0&&Be(r,((t,e)=>{r[e].timeUpdate=u}))),r=i?r[0]:r}async function Pn(t,e,r,n){let o,i=null;if(!Ge(Dn))return Promise.reject("無有效woItems");let u=$r(Dn,e,null);if(null===u)return Promise.reject(`ORM找不到表名稱: ${e}`);if("select"===r){if(o=await u.select(n).catch((t=>{console.log(`${e}.select catch`,t),i="取得資料失敗"})),Xe(i))return Promise.reject(i)}else if("insert"===r||"save"===r){try{n=Mn(e,t,n,r)}catch(t){return console.log("adjustData catch",t.toString()),i="調整資料失敗",Promise.reject(i)}if("insert"===r?o=await u.insert(n).catch((t=>{console.log(`${e}.save catch`,t),i="新增資料失敗"})):"save"===r&&(o=await u.save(n,{atomic:!0}).catch((t=>{console.log(`${e}.save catch`,t),i="儲存資料失敗"}))),Xe(i))return Promise.reject(i);o=Ve(n)?wn(n,(t=>({id:t.id}))):{id:n.id}}else if("del"===r)o=await u.del(n).catch((t=>{console.log(`${e}.del catch`,t),i="刪除資料失敗"}));else if("delAll"===r)o=await u.delAll(n).catch((t=>{console.log(`${e}.delAll catch`,t),i="刪除資料失敗"}));else if("mix"===r){if(!Ge(n))return Promise.reject("mix僅支援輸入ltdtDiffByKey結果物件");let r;o=[];let a=$r(n,"add",[]);if(oe(a)>0){try{a=Mn(e,t,a,"insert+save")}catch(t){return console.log("adjustData catch",t.toString()),i="調整資料失敗",Promise.reject(i)}if(await u.insert(a).catch((t=>{console.log(`${e}.save catch`,t),i="新增資料失敗"})),Xe(i))return Promise.reject(i);r=wn(a,(t=>({id:t.id}))),o=[...o,...r]}let c=$r(n,"del",[]);if(oe(c)>0){if(await u.del(c).catch((t=>{console.log(`${e}.save catch`,t),i="刪除資料失敗"})),Xe(i))return Promise.reject(i);r=wn(c,(t=>({id:t.id}))),o=[...o,...r]}let s=$r(n,"diff",[]);if(oe(s)>0){try{s=Mn(e,t,s)}catch(t){return console.log("adjustData catch",t.toString()),i="調整資料失敗",Promise.reject(i)}if(await u.save(s).catch((t=>{console.log(`${e}.save catch`,t),i="變更資料失敗"})),Xe(i))return Promise.reject(i);r=wn(s,(t=>({id:t.id}))),o=[...o,...r]}}else i=`invalid mode: ${r}`;return Xe(i)?Promise.reject(i):o}function An(t,e){return Sn=t,Dn=e,Pn}function xn(t,e){var r=[];return We(t,(function(t,n,o){e(t,n,o)&&r.push(t)})),r}function kn(t){let e=!1;if(Xe(t))e=!isNaN(Number(t));else if(function(t){return"[object Number]"===Object.prototype.toString.call(t)}(t)){if(function(t){return t!=t}(t))return!1;e=!0}return e}function In(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!Ve(t)){let t=Re();return t.reject("pms is not an array"),t}return t.reduce(((t,e)=>t.then(e)),Promise.resolve(e))}let Tn=[],zn=[],En=[],Nn=null,Fn=null,Cn=!0,Un=!0;function Yn(t){setTimeout((()=>{Tn.push(t)}),1)}function Ln(t){setTimeout((()=>{zn.push(t)}),1)}function Wn(t){setTimeout((()=>{En.push(t)}),1)}async function Hn(t,e,r,n){if(!Ze(Nn))return Promise.reject("invalid mapOrm");if(Cn&&!Xe(t))return console.log("userId",t),console.log("找不到使用者主鍵"),Promise.reject("找不到使用者主鍵");let o="n";if(Cn){if(!Ze(Fn))return Promise.reject("invalid getUserById");let e=await Fn(t);if(!e)return console.log("userId",t),console.log("找不到使用者資訊"),Promise.reject("找不到使用者資訊");o=$r(e,"isAdmin"),"y"!==o&&"n"!==o&&(o="n");let r=$r(e,"isActive");if("y"!==r&&"n"!==r&&(r="n"),"y"!==r)return console.log("userId",t),console.log("oSelf",e),console.log("使用者被停權或無有效使用者資訊"),Promise.reject("使用者被停權或無有效使用者資訊")}if(await qe(Tn,(i=>i({woName:e,userId:t,isAdmin:o,mode:r,input:n}))),oe(zn)>0){let i={woName:e,userId:t,isAdmin:o,mode:r,input:n},u=await In(zn,i);n=u.input}let i=await Nn(t,e,r,n);var u,a;return Un&&"n"===o&&"select"===r&&Ve(i)&&(a=t=>{return r="isActive",!(Je(e=t)&&(Xe(r)||kn(r))&&r in e&&"n"===t.isActive);var e,r},i=(s(u=i)?qr:xn)(u,jn(a))),oe(En)>0&&(i=await In(En,{woName:e,userId:t,isAdmin:o,mode:r,input:n,output:i})),i}function Bn(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function Rn(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?Bn(Object(r),!0).forEach((function(e){n(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):Bn(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}return function(t,e,r,n){let o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=function(t,e,r,n){if(!Ge(t))throw console.log("ds",t),new Error("invalid ds");if(!Ze(e))throw console.log("WOrm",e),new Error("invalid WOrm");if(!Xe(r))throw console.log("url",r),new Error("invalid url");if(!Xe(n))throw console.log("db",n),new Error("invalid db");let o={};return Be(Ye(t),(t=>{let i=new e({url:r,db:n,cl:t});o[t]=i})),o}(t,e,r,n),u=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ze(t)?(Nn=t,Cn=$r(e,"bCheckUser"),Qe(Cn)||(Cn=!0),Fn=$r(e,"getUserById"),Un=$r(e,"bExcludeWhenNotAdmin"),Qe(Un)||(Un=!0),{addFunCheck:Yn,addFunPreProcessing:Ln,addFunPostProcessing:Wn,procOrm:Hn}):Promise.reject("invalid mapOrm")}(An(t,i),o);return Rn(Rn({},tr),{},{woItems:i},u)}}));
//# sourceMappingURL=w-serv-orm.umd.js.map
